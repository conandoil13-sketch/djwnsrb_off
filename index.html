<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SmartAcademy Pro - Ultimate Master Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            z-index: 600;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .dropdown-menu {
            position: absolute;
            z-index: 100;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            overflow: hidden;
            min-width: 160px;
        }

        .line-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 2s ease-in-out forwards;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: 0;
            }
        }

        th.sortable {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        th.sortable:hover {
            background-color: #f1f5f9;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">

    <div id="toast" class="toast font-bold text-sm shadow-2xl text-center"></div>

    <div id="confirm-modal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 space-y-6 shadow-2xl animate-in zoom-in-95">
            <div class="text-center space-y-2">
                <div id="confirm-icon-bg" class="w-16 h-16 rounded-2xl mx-auto flex items-center justify-center mb-4">
                    <i id="confirm-icon" data-lucide="alert-triangle"></i>
                </div>
                <h3 id="confirm-title" class="text-xl font-black text-slate-800">확인</h3>
                <p id="confirm-message" class="text-sm text-slate-500 font-medium whitespace-pre-line"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirm()"
                    class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold">취소</button>
                <button id="confirm-action-btn"
                    class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-black">확인</button>
            </div>
        </div>
    </div>

    <div id="import-modal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[250] flex items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col animate-in zoom-in-95">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-50 text-indigo-600 p-3 rounded-2xl"><i data-lucide="file-text"></i></div>
                    <div>
                        <h3 class="text-xl font-black text-slate-800">엑셀 일괄 가져오기</h3>
                        <p id="import-week-hint" class="text-xs text-slate-400 font-bold">현재 주차 데이터로 입력됩니다.</p>
                    </div>
                </div>
                <button onclick="closeImportModal()" class="text-slate-400"><i data-lucide="x"></i></button>
            </div>
            <div class="p-8 space-y-4">
                <p class="text-xs text-slate-500 leading-relaxed font-medium">
                    엑셀에서 <span class="text-indigo-600 font-bold">[이름 / 학생번호 / 학부모번호 / 과제 / 시험1 / 시험2 / 오답]</span> 순으로
                    드래그 복사하여 아래에 붙여넣으세요.<br>
                    * 이름 + 학부모번호가 같은 학생은 기존 데이터를 업데이트합니다.
                </p>
                <textarea id="import-area"
                    class="w-full h-64 p-6 bg-slate-50 border border-slate-200 rounded-3xl text-xs outline-none focus:ring-4 focus:ring-indigo-100 transition-all font-mono"
                    placeholder="데이터를 붙여넣으세요..."></textarea>
            </div>
            <div class="p-8 bg-slate-50 flex gap-3">
                <button onclick="closeImportModal()"
                    class="flex-1 py-4 bg-white text-slate-400 rounded-2xl font-bold border border-slate-200">취소</button>
                <button onclick="processImport()"
                    class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-100">가져오기
                    실행</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[150] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-6 shadow-2xl animate-in zoom-in-95">
            <div class="text-center space-y-2">
                <div
                    class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-2xl mx-auto flex items-center justify-center mb-4">
                    <i data-lucide="database"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800">시험 결과로 전송</h3>
                <p class="text-sm text-slate-400 font-medium text-center">채점된 50점 만점 총점을<br>학생부 시트로 보냅니다.</p>
            </div>
            <div class="space-y-4">
                <select id="transfer-week-select"
                    class="w-full py-3 bg-slate-50 border border-slate-200 rounded-xl text-center font-black outline-none"></select>
                <div class="flex gap-2">
                    <button onclick="setTransferTarget('exam1')" id="btn-target-exam1"
                        class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-black text-sm">시험 1</button>
                    <button onclick="setTransferTarget('exam2')" id="btn-target-exam2"
                        class="flex-1 py-3 bg-slate-100 text-slate-400 rounded-xl font-black text-sm">시험 2</button>
                </div>
            </div>
            <div class="flex gap-3 pt-2">
                <button onclick="closeTransferModal()"
                    class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold">취소</button>
                <button onclick="executeTransfer()"
                    class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-black shadow-lg">전송하기</button>
            </div>
        </div>
    </div>

    <!-- ✅ NEW: 필터 모달 -->
    <div id="filter-modal"
        class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[260] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2.2rem] shadow-2xl overflow-hidden animate-in zoom-in-95">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-slate-100 text-slate-700 p-3 rounded-2xl"><i data-lucide="filter"></i></div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">필터</h3>
                        <p id="filter-week-hint" class="text-[11px] text-slate-400 font-bold">현재 주차 기준</p>
                    </div>
                </div>
                <button onclick="closeFilterModal()" class="text-slate-400"><i data-lucide="x"></i></button>
            </div>

            <div class="p-6 space-y-5">
                <div class="space-y-2">
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">과제/출석</label>
                    <select id="filter-hw"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl font-black outline-none">
                        <option value="ALL">전체</option>
                        <option value="제출">제출</option>
                        <option value="미제출">미제출</option>
                        <option value="미흡">미흡</option>
                        <option value="신규">신규</option>
                        <option value="결석">결석</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-2">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">시험 1
                            이상</label>
                        <input id="filter-min-exam1" type="number" min="0" placeholder="예: 40"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl font-black outline-none focus:ring-4 focus:ring-indigo-100">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">시험 2
                            이상</label>
                        <input id="filter-min-exam2" type="number" min="0" placeholder="예: 45"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl font-black outline-none focus:ring-4 focus:ring-indigo-100">
                    </div>
                </div>

                <div class="text-[11px] font-bold text-slate-400 leading-relaxed">
                    * 필터는 <span class="text-slate-700">현재 주차</span> 기준으로 적용됩니다.<br>
                    * 필터가 켜진 상태에서 “엑셀 복사/뿌리오 복사”를 하면 <span class="text-slate-700">조건에 맞는 학생만</span> 복사됩니다.
                </div>
            </div>

            <div class="p-6 bg-slate-50 flex gap-3">
                <button onclick="resetFilter()"
                    class="flex-1 py-3 bg-white text-slate-600 rounded-2xl font-black border border-slate-200 hover:bg-slate-50 transition-all">
                    초기화
                </button>
                <button onclick="applyFilter()"
                    class="flex-1 py-3 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">
                    적용
                </button>
            </div>
        </div>
    </div>

    <div id="hw-selector-menu" class="dropdown-menu">
        <button onclick="setHomeworkStatus('제출')"
            class="px-4 py-2 text-xs font-bold text-emerald-600 hover:bg-emerald-50 text-left">제출</button>
        <button onclick="setHomeworkStatus('미제출')"
            class="px-4 py-2 text-xs font-bold text-rose-600 hover:bg-rose-50 text-left">미제출</button>
        <button onclick="setHomeworkStatus('미흡')"
            class="px-4 py-2 text-xs font-bold text-amber-600 hover:bg-amber-50 text-left">미흡</button>
        <button onclick="setHomeworkStatus('신규')"
            class="px-4 py-2 text-xs font-bold text-sky-600 hover:bg-sky-50 text-left">신규</button>
        <button onclick="setHomeworkStatus('결석')"
            class="px-4 py-2 text-xs font-bold text-slate-500 hover:bg-slate-100 text-left">결석</button>
    </div>

    <!-- ✅ 발송(뿌리오) 드롭다운 (기존 재사용) -->
    <div id="ppurio-menu" class="dropdown-menu">
        <button onclick="copyForPpurio('parent')"
            class="px-4 py-2 text-xs font-black text-indigo-600 hover:bg-indigo-50 text-left flex items-center gap-2">
            <i data-lucide="users" size="14"></i> 학부모 발송
        </button>
        <button onclick="copyForPpurio('student')"
            class="px-4 py-2 text-xs font-black text-slate-700 hover:bg-slate-50 text-left flex items-center gap-2">
            <i data-lucide="user" size="14"></i> 학생 발송
        </button>
        <button onclick="copyForPpurio('both')"
            class="px-4 py-2 text-xs font-black text-emerald-600 hover:bg-emerald-50 text-left flex items-center gap-2">
            <i data-lucide="copy" size="14"></i> 둘 다 발송
        </button>
    </div>

    <!-- ✅ 새로 추가: 데이터 메뉴 (엑셀 가져오기/복사 묶음) -->
    <div id="data-menu" class="dropdown-menu">
        <button onclick="openImportModal()"
            class="px-4 py-2 text-xs font-black text-indigo-600 hover:bg-indigo-50 text-left flex items-center gap-2">
            <i data-lucide="file-up" size="14"></i> 엑셀 일괄 가져오기
        </button>
        <button onclick="copyTableToExcel()"
            class="px-4 py-2 text-xs font-black text-slate-700 hover:bg-slate-50 text-left flex items-center gap-2">
            <i data-lucide="copy" size="14"></i> 엑셀 형태로 복사
        </button>
    </div>

    <!-- ✅ 새로 추가: 주차 메뉴 (+주차 추가 / -주차 삭제 묶음) -->
    <div id="week-menu" class="dropdown-menu">
        <button onclick="addNewWeek()"
            class="px-4 py-2 text-xs font-black text-indigo-600 hover:bg-indigo-50 text-left flex items-center gap-2">
            <i data-lucide="plus" size="14"></i> 주차 추가
        </button>
        <button onclick="removeLastWeek()"
            class="px-4 py-2 text-xs font-black text-rose-600 hover:bg-rose-50 text-left flex items-center gap-2">
            <i data-lucide="minus" size="14"></i> 마지막 주차 삭제
        </button>
    </div>

    <div id="class-selection" class="min-h-screen flex items-center justify-center p-6">
        <div class="max-w-6xl w-full space-y-12">
            <div class="text-center space-y-4">
                <div
                    class="bg-indigo-600 w-20 h-20 rounded-3xl mx-auto flex items-center justify-center text-white shadow-xl mb-6">
                    <i data-lucide="graduation-cap" size="40"></i>
                </div>
                <h1 class="text-5xl font-black text-slate-800 tracking-tight">SmartAcademy <span
                        class="text-indigo-600">Pro</span></h1>
                <p class="text-slate-400 font-bold uppercase tracking-widest text-sm">탐구 과목 통합 관리 시스템 v6.2 (LOCAL SAFE)
                </p>

                <div class="flex flex-wrap gap-4 justify-center mt-8">
                    <button onclick="openClassModal()"
                        class="px-8 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2">
                        <i data-lucide="plus"></i> 새 수업 등록
                    </button>

                    <button onclick="exportBackupJSON()"
                        class="px-8 py-4 bg-white text-slate-700 border border-slate-200 rounded-2xl font-black hover:bg-slate-50 transition-all flex items-center gap-2">
                        <i data-lucide="download"></i> 백업 내보내기(JSON)
                    </button>

                    <button onclick="triggerImportBackupJSON()"
                        class="px-8 py-4 bg-white text-slate-700 border border-slate-200 rounded-2xl font-black hover:bg-slate-50 transition-all flex items-center gap-2">
                        <i data-lucide="upload"></i> 백업 불러오기(JSON)
                    </button>

                    <button onclick="triggerResetData()"
                        class="px-8 py-4 bg-white text-rose-500 border border-rose-100 rounded-2xl font-black hover:bg-rose-50 transition-all text-sm uppercase tracking-widest">
                        데이터 초기화
                    </button>

                    <input id="backup-file-input" type="file" accept="application/json" class="hidden" />
                </div>

                <p class="text-xs text-slate-400 font-bold mt-2">
                    * 로컬 저장(브라우저) 방식입니다. 브라우저 데이터 삭제/시크릿 모드/저장공간 부족 시 데이터가 사라질 수 있어요 → “백업 내보내기”를 자주 쓰는 게 가장 안전합니다.
                </p>
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="class-list"></div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden min-h-screen flex flex-col">
        <nav class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
            <div class="max-w-[1600px] mx-auto px-6 h-20 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="exitToClassSelection()"
                        class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <div>
                        <h2 id="active-class-name" class="font-black text-xl text-slate-800 tracking-tight">수업명</h2>
                        <p id="active-class-schedule"
                            class="text-[10px] text-slate-400 font-black tracking-widest uppercase">SCHEDULE</p>
                    </div>
                </div>

                <div class="flex bg-slate-100 p-1 rounded-2xl shadow-inner">
                    <button onclick="switchTab('students')" id="tab-btn-students"
                        class="px-6 py-2.5 rounded-xl text-xs font-black transition-all bg-white text-indigo-600 shadow-sm">학생
                        관리</button>
                    <button onclick="switchTab('mock')" id="tab-btn-mock"
                        class="px-6 py-2.5 rounded-xl text-xs font-black transition-all text-slate-400">모의고사</button>
                    <button onclick="switchTab('grading')" id="tab-btn-grading"
                        class="px-6 py-2.5 rounded-xl text-xs font-black transition-all text-slate-400">자동 채점</button>
                    <button onclick="switchTab('withdrawn')" id="tab-btn-withdrawn"
                        class="px-6 py-2.5 rounded-xl text-xs font-black transition-all text-slate-400">퇴원생</button>
                </div>
            </div>
        </nav>

        <!-- ✅ 학생관리 -->
        <main id="content-students" class="max-w-[1600px] mx-auto w-full p-6 space-y-6">
            <!-- ✅ 정리된 툴바 -->
            <div
                class="flex flex-wrap items-center justify-between gap-4 bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
                <!-- Left: 주차 네비 + 주차 메뉴 -->
                <div class="flex items-center gap-3">
                    <div class="flex items-center bg-slate-100 rounded-2xl p-1 shadow-inner">
                        <button onclick="changeWeek(-1)"
                            class="p-2 hover:bg-white rounded-xl transition-all text-slate-400 hover:text-slate-600">
                            <i data-lucide="chevron-left" size="18"></i>
                        </button>

                        <select id="week-selector" onchange="jumpToWeek(this.value)"
                            class="bg-transparent px-4 font-black text-indigo-600 outline-none cursor-pointer appearance-none text-center min-w-[110px]"></select>

                        <button onclick="changeWeek(1)"
                            class="p-2 hover:bg-white rounded-xl transition-all text-slate-400 hover:text-slate-600">
                            <i data-lucide="chevron-right" size="18"></i>
                        </button>
                    </div>

                    <button onclick="openWeekMenu(this)"
                        class="flex items-center gap-2 px-4 py-2 bg-white text-slate-700 border border-slate-200 rounded-2xl text-xs font-black hover:bg-slate-50 transition-all shadow-sm">
                        <i data-lucide="calendar-cog" size="16" class="text-slate-500"></i> 주차 관리 <i
                            data-lucide="chevron-down" size="14" class="text-slate-400"></i>
                    </button>

                    <!-- ✅ 선택 상태(0명일 때 숨김) -->
                    <div id="selection-chip"
                        class="hidden items-center gap-2 ml-1 px-4 py-2 rounded-2xl bg-indigo-50 text-indigo-700 text-xs font-black border border-indigo-100">
                        <i data-lucide="check-square" size="16"></i>
                        <span>선택됨</span>
                        <span id="selection-count"
                            class="px-2 py-1 rounded-xl bg-white text-indigo-600 border border-indigo-100">(0)</span>
                        <button onclick="clearSelection()"
                            class="ml-1 px-3 py-1.5 rounded-xl bg-white text-slate-500 border border-slate-200 hover:bg-slate-50 text-[11px] font-black">
                            선택 해제
                        </button>
                    </div>
                </div>

                <!-- Right: 검색 + 필터 + 핵심 액션(그룹 버튼) + 학생추가 -->
                <div class="flex items-center gap-3 flex-wrap justify-end">
                    <!-- 검색 -->
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-3 text-slate-400" size="14"></i>
                        <input type="text" id="student-search" oninput="renderTable()" placeholder="이름 검색..."
                            class="pl-9 pr-4 py-2 border border-slate-200 rounded-xl text-xs outline-none focus:ring-2 focus:ring-indigo-500 w-40 transition-all">
                    </div>

                    <!-- ✅ NEW: 필터 버튼 -->
                    <button onclick="openFilterModal()"
                        class="relative flex items-center gap-2 px-4 py-2 bg-white text-slate-700 border border-slate-200 rounded-2xl text-xs font-black hover:bg-slate-50 transition-all shadow-sm">
                        <i data-lucide="filter" size="16" class="text-slate-500"></i> 필터
                        <span id="filter-badge"
                            class="hidden absolute -top-1 -right-1 w-3 h-3 rounded-full bg-indigo-600 ring-2 ring-white"></span>
                    </button>

                    <!-- 데이터 드롭다운 -->
                    <button onclick="openDataMenu(this)"
                        class="flex items-center gap-2 px-5 py-2.5 bg-white text-slate-700 border border-slate-200 rounded-2xl text-xs font-black hover:bg-slate-50 transition-all shadow-sm">
                        <i data-lucide="database" size="16" class="text-slate-500"></i> 데이터 <i
                            data-lucide="chevron-down" size="14" class="text-slate-400"></i>
                    </button>

                    <!-- 발송(뿌리오) 드롭다운 -->
                    <button onclick="openPpurioMenu(this)"
                        class="flex items-center gap-2 px-5 py-2.5 bg-white text-slate-700 border border-slate-200 rounded-2xl text-xs font-black hover:bg-slate-50 transition-all shadow-sm">
                        <i data-lucide="send" size="16" class="text-slate-500"></i> 발송 <i data-lucide="chevron-down"
                            size="14" class="text-slate-400"></i>
                    </button>

                    <!-- ✅ 선택 있을 때만 보이는: 과제/출석 일괄 변경 -->
                    <button id="bulk-hw-btn" onclick="openBulkHwMenu(event, this)"
                        class="hidden flex items-center gap-2 px-5 py-2.5 bg-indigo-600 text-white rounded-2xl text-xs font-black hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                        <i data-lucide="check-square" size="18"></i> 과제/출석 일괄 변경 <span id="bulk-hw-count"
                            class="text-indigo-100 font-black">(0)</span>
                    </button>

                    <!-- 학생 추가 (Primary) -->
                    <button onclick="addNewStudent()"
                        class="bg-slate-900 text-white px-5 py-2.5 rounded-2xl font-black flex items-center gap-2 hover:bg-slate-800 text-xs shadow-lg">
                        <i data-lucide="user-plus" size="16"></i> 학생 추가
                    </button>
                </div>
            </div>

            <div id="table-container"
                class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden overflow-x-auto custom-scrollbar">
                <table class="w-full border-collapse" id="main-table">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th
                                class="px-4 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest w-14">
                                <input id="select-all-students" type="checkbox" onchange="toggleSelectAll(this.checked)"
                                    class="w-4 h-4 accent-indigo-600 cursor-pointer">
                            </th>

                            <th onclick="handleSort('name')"
                                class="sortable px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest w-40">
                                <div class="flex items-center gap-1">학생 이름 <i data-lucide="arrow-up-down" size="12"></i>
                                </div>
                            </th>
                            <th
                                class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest w-52">
                                학생 번호</th>
                            <th
                                class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest w-52">
                                학부모 번호</th>
                            <th onclick="handleSort('homework')"
                                class="sortable px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest w-36">
                                <div class="flex items-center justify-center gap-1">과제/출석 <i data-lucide="arrow-up-down"
                                        size="12"></i>
                                </div>
                            </th>
                            <th onclick="handleSort('exam1')"
                                class="sortable px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest w-24">
                                <div class="flex items-center justify-center gap-1">시험 1 (50) <i
                                        data-lucide="arrow-up-down" size="12"></i></div>
                            </th>
                            <th onclick="handleSort('exam2')"
                                class="sortable px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest w-24">
                                <div class="flex items-center justify-center gap-1">시험 2 (50) <i
                                        data-lucide="arrow-up-down" size="12"></i></div>
                            </th>
                            <th
                                class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                오답 문항 번호</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </main>

        <main id="content-mock" class="hidden max-w-[1600px] mx-auto w-full p-6 space-y-6">
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-2xl font-black text-slate-800 flex items-center gap-3"><i data-lucide="award"
                            class="text-amber-500"></i> 모의고사 성적 기록 (50점 만점)</h3>
                </div>
                <div class="overflow-hidden border border-slate-100 rounded-3xl">
                    <table class="w-full border-collapse">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <tr>
                                <th onclick="handleMockSort('name')" class="sortable px-6 py-4 text-left">
                                    <div class="flex items-center gap-1">학생 이름 <i data-lucide="arrow-up-down"
                                            size="10"></i></div>
                                </th>
                                <th onclick="handleMockSort('june')" class="sortable px-6 py-4 text-center w-48">
                                    <div class="flex items-center justify-center gap-1">6월 모의고사 <i
                                            data-lucide="arrow-up-down" size="10"></i></div>
                                </th>
                                <th onclick="handleMockSort('sept')" class="sortable px-6 py-4 text-center w-48">
                                    <div class="flex items-center justify-center gap-1">9월 모의고사 <i
                                            data-lucide="arrow-up-down" size="10"></i></div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="mock-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <main id="content-grading" class="hidden max-w-[1600px] mx-auto w-full p-6 space-y-6">
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm space-y-6">
                <div class="flex items-center justify-between border-b border-slate-100 pb-6">
                    <h3 class="text-2xl font-black text-slate-800 flex items-center gap-3"><i data-lucide="calculator"
                            class="text-indigo-600"></i> 자동 채점 시스템 (50점 만점)</h3>
                    <div class="flex gap-3">
                        <button onclick="loadStudentsToGrading()"
                            class="px-6 py-3 bg-slate-100 text-slate-600 rounded-2xl font-black text-xs hover:bg-slate-200 flex items-center gap-2"><i
                                data-lucide="refresh-cw" size="16"></i> 학생 명단 동기화</button>
                        <button onclick="runGrading()"
                            class="px-8 py-3 bg-indigo-600 text-white rounded-2xl font-black text-xs hover:bg-indigo-700 shadow-lg flex items-center gap-2"><i
                                data-lucide="check-circle" size="16"></i> 채점 실행</button>
                        <button onclick="openTransferModal()"
                            class="px-8 py-3 bg-emerald-600 text-white rounded-2xl font-black text-xs hover:bg-emerald-700 shadow-lg flex items-center gap-2"><i
                                data-lucide="send" size="16"></i> 시험 결과로 입력</button>
                    </div>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full border-collapse min-w-[1000px] text-center text-sm">
                        <tbody>
                            <tr class="bg-slate-50/50">
                                <td
                                    class="p-3 border border-slate-200 text-[10px] font-black text-slate-400 uppercase w-20">
                                    정답</td>
                                <script>
                                    for (let i = 1; i <= 20; i++) {
                                        document.write(`<td class="p-1 border border-slate-200"><input type="text" id="ans-${i}" class="w-full text-center py-2 font-black text-indigo-600 bg-white border border-slate-200 rounded-lg outline-none" maxLength="1"></td>`);
                                    }
                                </script>
                            </tr>
                            <tr>
                                <td class="p-3 border border-slate-200 text-[10px] font-black text-slate-400 uppercase">
                                    배점</td>
                                <script>
                                    for (let i = 1; i <= 20; i++) {
                                        document.write(`<td class="p-1 border border-slate-200"><select id="pt-${i}" class="w-full text-center py-2 text-xs font-bold bg-white border border-slate-100 rounded-lg outline-none"><option value="2">2</option><option value="3" selected>3</option></select></td>`);
                                    }
                                </script>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div
                    class="bg-slate-50 rounded-3xl border border-slate-100 overflow-hidden overflow-x-auto custom-scrollbar">
                    <table class="w-full border-collapse min-w-[1200px]" id="grading-table">
                        <thead class="bg-slate-800 text-white text-[10px] font-black tracking-widest uppercase">
                            <tr>
                                <th class="w-10 bg-slate-800 border-r border-slate-700"></th>
                                <th onclick="handleGradingSort()"
                                    class="sortable px-4 py-4 sticky left-10 bg-slate-800 z-10 w-32 border-r border-slate-700 shadow-sm">
                                    <div class="flex items-center justify-center gap-1 cursor-pointer">이름 <i
                                            data-lucide="arrow-up-down" size="10"></i></div>
                                </th>
                                <script>
                                    for (let i = 1; i <= 20; i++) document.write(`<th class="p-2 border-r border-slate-700">${i}</th>`);
                                </script>
                                <th class="px-6 py-4 bg-indigo-500">총점 (50)</th>
                                <th class="px-6 py-4 bg-rose-500">오답</th>
                            </tr>
                        </thead>
                        <tbody id="grading-body" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>

                <div class="flex items-center justify-around bg-slate-900 text-white p-8 rounded-3xl shadow-2xl mt-4">
                    <div class="text-center">
                        <p class="text-slate-500 text-[10px] font-black uppercase mb-1">응시자 수</p>
                        <p id="stat-count" class="text-3xl font-black">0명</p>
                    </div>
                    <div class="text-center">
                        <p class="text-emerald-400 text-[10px] font-black uppercase mb-1">최고 점수</p>
                        <p id="stat-max" class="text-3xl font-black">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-rose-400 text-[10px] font-black uppercase mb-1">최저 점수</p>
                        <p id="stat-min" class="text-3xl font-black">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-indigo-400 text-[10px] font-black uppercase mb-1">응시자 평균</p>
                        <p id="stat-avg" class="text-3xl font-black">0.0</p>
                    </div>
                </div>
            </div>
        </main>

        <main id="content-withdrawn" class="hidden max-w-[1600px] mx-auto w-full p-6 space-y-6">
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="bg-slate-100 text-slate-600 p-3 rounded-2xl"><i data-lucide="archive"></i></div>
                        <div>
                            <h3 class="text-2xl font-black text-slate-800">퇴원생 목록</h3>
                            <p class="text-xs text-slate-400 font-bold">단축키: Ctrl/Cmd + ; 로 열기/닫기</p>
                        </div>
                    </div>
                </div>

                <div class="overflow-hidden border border-slate-100 rounded-3xl">
                    <table class="w-full border-collapse">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <tr>
                                <th class="px-6 py-4 text-left w-40">이름</th>
                                <th class="px-6 py-4 text-left w-52">학생 번호</th>
                                <th class="px-6 py-4 text-left w-52">학부모 번호</th>
                                <th class="px-6 py-4 text-left w-48">퇴원일</th>
                                <th class="px-6 py-4 text-right">관리</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawn-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="class-modal"
        class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-in zoom-in-95">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <h2 id="class-modal-title" class="text-2xl font-black text-slate-800 tracking-tight">수업 정보</h2>
                <button onclick="closeClassModal()" class="text-slate-300 hover:text-slate-500 transition-colors"><i
                        data-lucide="x"></i></button>
            </div>
            <div class="p-8 space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">수업명</label>
                    <input type="text" id="modal-input-name"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">시간 정보</label>
                    <input type="text" id="modal-input-schedule" placeholder="토요일 09:30"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                </div>
            </div>
            <div class="p-8 bg-slate-50 flex gap-3">
                <button onclick="closeClassModal()"
                    class="flex-1 py-4 bg-white text-slate-400 rounded-xl font-bold border border-slate-200 hover:bg-slate-50 transition-all">취소</button>
                <button onclick="saveClass()"
                    class="flex-1 py-4 bg-indigo-600 text-white rounded-xl font-black shadow-lg">저장</button>
            </div>
        </div>
    </div>

    <div id="student-modal"
        class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-xl z-50 flex items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-4xl rounded-[3rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in zoom-in-95">
            <div class="p-10 border-b border-slate-100 flex justify-between items-start bg-indigo-50/30">
                <div class="flex items-center gap-6">
                    <div class="bg-white p-5 rounded-[2rem] text-indigo-600 shadow-xl border border-indigo-50">
                        <i data-lucide="user" size="40"></i>
                    </div>
                    <div>
                        <h2 id="modal-student-name" class="text-4xl font-black text-slate-800 tracking-tight">이름</h2>
                        <p id="modal-student-info"
                            class="text-indigo-600/60 font-black text-xs uppercase mt-2 tracking-widest">
                            STUDENT PROFILE</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="withdraw-trigger-btn"
                        class="px-5 py-2.5 bg-rose-50 text-rose-600 border border-rose-100 rounded-2xl font-black text-xs hover:bg-rose-100 transition-all flex items-center gap-2"><i
                            data-lucide="user-minus" size="16"></i> 퇴원 처리</button>
                    <button onclick="closeModal()" class="text-slate-300 hover:text-slate-500 p-2 transition-all"><i
                            data-lucide="x" size="32"></i></button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-10 space-y-10 custom-scrollbar">
                <div class="grid grid-cols-3 gap-6">
                    <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 text-center">
                        <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">출석률</p>
                        <p id="modal-att-rate" class="text-3xl font-black text-indigo-600">0%</p>
                    </div>
                    <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 text-center">
                        <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">평균 성적</p>
                        <p id="modal-avg-score" class="text-3xl font-black text-slate-800">0</p>
                    </div>
                    <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 text-center">
                        <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">과제 제출율</p>
                        <p id="modal-hw-rate" class="text-3xl font-black text-emerald-600">0%</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 bg-amber-50 p-6 rounded-[2rem] border border-amber-100">
                    <div>
                        <p class="text-amber-600 text-[10px] font-black uppercase mb-1 tracking-widest">6월 모의고사 (50)</p>
                        <p id="modal-mock-june" class="text-xl font-black text-slate-800">-</p>
                    </div>
                    <div>
                        <p class="text-amber-600 text-[10px] font-black uppercase mb-1 tracking-widest">9월 모의고사 (50)</p>
                        <p id="modal-mock-sept" class="text-xl font-black text-slate-800">-</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <h3 class="font-black text-slate-800 text-xl tracking-tight flex items-center gap-2"><i
                            data-lucide="line-chart" size="20" class="text-indigo-600"></i> 성적 추이 (본인 vs 반 평균)</h3>
                    <div class="h-64 bg-slate-50 rounded-[2rem] border border-slate-100 relative p-8">
                        <svg id="trend-svg" class="w-full h-full overflow-visible"></svg>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-black text-slate-800 text-xl flex items-center gap-2">
                        <i data-lucide="sticky-note" size="20" class="text-amber-500"></i> 관리 비고 및 상담 기록
                    </h3>
                    <textarea id="modal-notes" oninput="saveNotes()"
                        class="w-full h-32 p-6 bg-slate-50 border border-slate-100 rounded-[2rem] text-sm outline-none resize-none focus:ring-4 focus:ring-indigo-100 transition-all shadow-inner"></textarea>
                </div>
            </div>

            <div class="p-8 bg-slate-50/50 text-center border-t border-slate-100">
                <button onclick="closeModal()"
                    class="w-full py-5 bg-slate-900 text-white rounded-[2rem] font-black text-lg active:scale-95 transition-all">관리
                    카드 닫기</button>
            </div>
        </div>
    </div>

    <script>
        // =============================
        // 시스템 코어 및 DB 핸들링
        // =============================
        const STORAGE_KEY = 'ACADEMY_MASTER_V6_STORAGE';
        const BACKUP_KEY = STORAGE_KEY + '__BACKUP';
        const META_KEY = STORAGE_KEY + '__META';
        const APP_VERSION = '6.2.0';

        let db = { classes: [], students: [] };

        let currentClassId = null,
            currentWeek = 1,
            totalWeeks = 10,
            activeHwStudentId = null,
            editingClassId = null,
            currentModalStudentId = null,
            gradingData = [],
            sortKey = 'name',
            sortDir = 'asc',
            gradingSortDir = 'asc',
            mockSortKey = 'name',
            mockSortDir = 'asc',
            transferTarget = 'exam1';

        const homeworkColors = {
            '제출': 'bg-emerald-500 text-white',
            '미제출': 'bg-rose-500 text-white',
            '미흡': 'bg-amber-500 text-white',
            '신규': 'bg-sky-500 text-white',
            '결석': 'bg-slate-400 text-white'
        };

        // ✅ 다중 선택(일괄 변경) 상태
        let selectedStudentIds = new Set();
        let _lastVisibleStudentIds = [];

        // ✅ NEW: 필터 상태 (학생탭/복사 기능 연동)
        // - hw: 'ALL' 또는 '제출' 등
        // - minExam1/minExam2: null이면 미적용
        let filterState = {
            hw: 'ALL',
            minExam1: null,
            minExam2: null
        };

        function safeParseJSON(text) { try { return JSON.parse(text); } catch { return null; } }
        function isValidDB(obj) { return obj && typeof obj === 'object' && Array.isArray(obj.classes) && Array.isArray(obj.students); }
        function getUUID() { return window.crypto?.randomUUID?.() || 'id-' + Date.now() + '-' + Math.random().toString(16).slice(2); }
        function escapeHtml(str) { return String(str).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])); }

        function showToast(m) {
            const t = document.getElementById('toast');
            if (t) {
                t.innerText = m;
                t.style.opacity = 1;
                clearTimeout(showToast._timer);
                showToast._timer = setTimeout(() => t.style.opacity = 0, 2000);
            }
        }

        // 입력 데이터 강제 동기화 (탭 전환/주차 전환 시 유실 방지)
        function syncActiveInputs({ save = true } = {}) {
            const container = document.getElementById('table-container');
            if (!container) return;
            const inputs = container.querySelectorAll('input[data-sync]');
            let touched = false;
            inputs.forEach(inp => {
                const id = inp.dataset.id;
                const field = inp.dataset.field;
                const kind = inp.dataset.sync;
                const s = db.students.find(x => x.id === id);
                if (!s) return;
                if (kind === 'student') {
                    const val = (inp.value ?? '').trim();
                    if (s[field] !== val) { s[field] = val; touched = true; }
                } else if (kind === 'week') {
                    if (!s.weeks) s.weeks = {};
                    if (!s.weeks[currentWeek]) s.weeks[currentWeek] = { homework: '미제출', exam1: 0, exam2: 0, incorrect: '' };
                    let val = (inp.value ?? '');
                    if (field === 'exam1' || field === 'exam2') val = Number(val || 0);
                    if (s.weeks[currentWeek][field] !== val) { s.weeks[currentWeek][field] = val; touched = true; }
                }
            });
            if (touched && save) saveDBImmediate();
        }

        function normalizeDB() {
            db.students = (db.students || []).map(s => {
                if (!s || typeof s !== 'object') return s;
                if (!s.weeks || typeof s.weeks !== 'object') s.weeks = {};
                if (typeof s.withdrawn !== 'boolean') s.withdrawn = false;
                if (typeof s.withdrawnAt !== 'number') s.withdrawnAt = 0;
                if (!s.mock) s.mock = { june: 0, sept: 0 };
                if (typeof s.notes !== 'string') s.notes = "";
                return s;
            });
            db.classes = (db.classes || []).map(c => {
                if (!c || typeof c !== 'object') return c;
                if (!Number.isFinite(c.weekCount) || c.weekCount < 1) {
                    c.weekCount = inferWeekCountForClass(c.id);
                }
                return c;
            });
        }

        function saveDBImmediate() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
                localStorage.setItem(META_KEY, JSON.stringify({ version: APP_VERSION, savedAt: Date.now() }));
                return true;
            } catch (e) { return false; }
        }

        function saveDB() {
            clearTimeout(window._saveTimer);
            window._saveTimer = setTimeout(() => saveDBImmediate(), 150);
        }

        function loadDB() {
            const raw = localStorage.getItem(STORAGE_KEY);
            const parsed = raw ? safeParseJSON(raw) : null;
            if (isValidDB(parsed)) { db = parsed; normalizeDB(); return; }
            generateSampleData();
            normalizeDB();
            saveDBImmediate();
        }

        function generateSampleData() {
            const cid = 'c-sample';
            db.classes = [{ id: cid, name: '예시 수업반', schedule: '토요일 09:30', weekCount: 1 }];
            db.students = [{
                id: getUUID(),
                classId: cid,
                name: '예시학생',
                studentPhone: '010-0000-0000',
                parentPhone: '010-1111-1111',
                withdrawn: false,
                withdrawnAt: 0,
                weeks: { 1: { homework: '제출', exam1: 45, exam2: 48, incorrect: '' } },
                mock: { june: 45, sept: 48 },
                notes: '성실함'
            }];
        }

        // =============================
        // ✅ NEW: 필터 로직 (테이블/복사 연동)
        // =============================
        function getWeekDataSafe(s, week = currentWeek) {
            return s.weeks?.[week] || { homework: '미제출', exam1: 0, exam2: 0, incorrect: '' };
        }

        function isFilterActive() {
            return (filterState.hw !== 'ALL')
                || (filterState.minExam1 !== null && filterState.minExam1 !== '')
                || (filterState.minExam2 !== null && filterState.minExam2 !== '');
        }

        function updateFilterBadge() {
            const badge = document.getElementById('filter-badge');
            if (!badge) return;
            badge.classList.toggle('hidden', !isFilterActive());
        }

        function passesFilter(student) {
            const d = getWeekDataSafe(student, currentWeek);

            if (filterState.hw && filterState.hw !== 'ALL') {
                if ((d.homework || '미제출') !== filterState.hw) return false;
            }

            if (filterState.minExam1 !== null && filterState.minExam1 !== '') {
                const v = Number(d.exam1 || 0);
                if (v < Number(filterState.minExam1)) return false;
            }

            if (filterState.minExam2 !== null && filterState.minExam2 !== '') {
                const v = Number(d.exam2 || 0);
                if (v < Number(filterState.minExam2)) return false;
            }

            return true;
        }

        // ✅ 학생 목록을 “한 군데”에서만 계산: (검색 + 필터 + 퇴원 제외)
        function getFilteredStudents({ includeSearch = true } = {}) {
            const search = includeSearch ? ((document.getElementById('student-search')?.value || "").toLowerCase()) : "";
            return db.students
                .filter(s => s.classId === currentClassId && !s.withdrawn)
                .filter(s => !includeSearch || (s.name || "").toLowerCase().includes(search))
                .filter(s => passesFilter(s));
        }

        function openFilterModal() {
            syncActiveInputs({ save: true });

            const hint = document.getElementById('filter-week-hint');
            if (hint) hint.innerText = `현재 ${currentWeek}주차 기준`;

            // 현재 상태를 UI에 반영
            const hw = document.getElementById('filter-hw');
            const e1 = document.getElementById('filter-min-exam1');
            const e2 = document.getElementById('filter-min-exam2');

            if (hw) hw.value = filterState.hw ?? 'ALL';
            if (e1) e1.value = (filterState.minExam1 ?? '');
            if (e2) e2.value = (filterState.minExam2 ?? '');

            document.getElementById('filter-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeFilterModal() {
            document.getElementById('filter-modal').classList.add('hidden');
        }

        function applyFilter() {
            const hw = document.getElementById('filter-hw')?.value ?? 'ALL';
            const e1raw = (document.getElementById('filter-min-exam1')?.value ?? '').toString().trim();
            const e2raw = (document.getElementById('filter-min-exam2')?.value ?? '').toString().trim();

            filterState.hw = hw;
            filterState.minExam1 = (e1raw === '' ? null : Number(e1raw));
            filterState.minExam2 = (e2raw === '' ? null : Number(e2raw));

            closeFilterModal();
            clearSelection();
            updateFilterBadge();
            renderTable();

            const cnt = getFilteredStudents({ includeSearch: true }).length;
            showToast(isFilterActive() ? `필터 적용됨 (${cnt}명)` : `필터 해제됨`);
        }

        function resetFilter() {
            filterState = { hw: 'ALL', minExam1: null, minExam2: null };

            // UI도 초기화
            const hw = document.getElementById('filter-hw');
            const e1 = document.getElementById('filter-min-exam1');
            const e2 = document.getElementById('filter-min-exam2');
            if (hw) hw.value = 'ALL';
            if (e1) e1.value = '';
            if (e2) e2.value = '';

            updateFilterBadge();
            clearSelection();
            renderTable();
            showToast('필터 초기화');
        }

        // =============================
        // 복사 및 주차 삭제
        // =============================
        async function copyTableToExcel() {
            syncActiveInputs({ save: true });

            const filtered = getFilteredStudents({ includeSearch: true });
            if (filtered.length === 0) return showToast("조건에 해당하는 학생이 없습니다.");

            let tsv = "이름\t학생번호\t학부모번호\t과제/출석\t시험1\t시험2\t오답\n";
            filtered.forEach(s => {
                const d = getWeekDataSafe(s, currentWeek);
                tsv += `${s.name}\t${s.studentPhone}\t${s.parentPhone}\t${d.homework}\t${d.exam1}\t${d.exam2}\t${d.incorrect}\n`;
            });

            try {
                await navigator.clipboard.writeText(tsv);
                showToast("현재(검색+필터) 결과가 엑셀 규격으로 복사되었습니다.");
            } catch (err) { showToast("복사 실패"); }
        }

        function removeLastWeek() {
            const cls = getActiveClassObj();
            if (!cls) return;

            if ((Number(cls.weekCount) || 1) <= 1) return showToast("삭제할 주차가 없습니다.");

            const delWeek = cls.weekCount;

            openConfirm("주차 삭제",
                `현재 가장 마지막 주차인 ${delWeek}주차를 삭제하시겠습니까?\n해당 주차에 입력된 데이터는 복구할 수 없습니다.`,
                () => {
                    db.students
                        .filter(s => s.classId === currentClassId)
                        .forEach(s => {
                            if (s.weeks && typeof s.weeks === 'object') delete s.weeks[delWeek];
                        });

                    cls.weekCount = delWeek - 1;
                    totalWeeks = cls.weekCount;
                    currentWeek = Math.min(currentWeek, totalWeeks);

                    saveDB();
                    renderWeekSelector();
                    renderTable();
                    updateFilterBadge();
                    showToast(`${delWeek}주차 삭제 완료`);
                }
            );
        }

        async function copyForPpurio(mode = 'parent') {
            syncActiveInputs({ save: true });
            const menu = document.getElementById('ppurio-menu');
            if (menu) menu.style.display = 'none';

            // ✅ 검색+필터 결과만 대상으로
            const students = getFilteredStudents({ includeSearch: true });
            if (!students.length) return showToast("조건에 해당하는 학생이 없습니다.");

            let lines = [];

            students.forEach(s => {
                const d = getWeekDataSafe(s, currentWeek);

                if (mode === 'student' || mode === 'both') {
                    const sp = (s.studentPhone || "").trim();
                    if (sp) lines.push(`${s.name}\t${sp}\t${d.homework}\t${d.exam1}\t${d.exam2}`);
                }

                if (mode === 'parent' || mode === 'both') {
                    const pp = (s.parentPhone || "").trim();
                    if (pp) lines.push(`${s.name}\t${pp}\t${d.homework}\t${d.exam1}\t${d.exam2}`);
                }
            });

            if (!lines.length) return showToast("복사할 연락처 정보가 없습니다.");
            await navigator.clipboard.writeText(lines.join('\n') + '\n');
            showToast(`뿌리오용 데이터 복사 완료 (${lines.length}건)`);
        }

        // =============================
        // ✅ 과제/출석 "일괄 변경" + 툴바 상태 UI
        // =============================
        function updateBulkUI() {
            const btn = document.getElementById('bulk-hw-btn');
            const countEl = document.getElementById('bulk-hw-count');
            const allEl = document.getElementById('select-all-students');

            const chip = document.getElementById('selection-chip');
            const chipCount = document.getElementById('selection-count');

            const validSelected = new Set(
                [...selectedStudentIds].filter(id => {
                    const s = db.students.find(x => x.id === id);
                    return s && s.classId === currentClassId && !s.withdrawn;
                })
            );
            selectedStudentIds = validSelected;

            const count = selectedStudentIds.size;

            if (countEl) countEl.innerText = `(${count})`;

            // ✅ 선택 있을 때만: 일괄 버튼/선택칩 노출
            if (btn) btn.classList.toggle('hidden', count === 0);
            if (chip) chip.classList.toggle('hidden', count === 0);
            if (chipCount) chipCount.innerText = `(${count})`;

            const visible = _lastVisibleStudentIds || [];
            if (allEl) {
                if (!visible.length) {
                    allEl.checked = false;
                    allEl.indeterminate = false;
                } else {
                    const selectedVisibleCount = visible.filter(id => selectedStudentIds.has(id)).length;
                    allEl.checked = selectedVisibleCount === visible.length;
                    allEl.indeterminate = selectedVisibleCount > 0 && selectedVisibleCount < visible.length;
                }
            }
        }

        function toggleSelectStudent(id, checked) {
            if (checked) selectedStudentIds.add(id);
            else selectedStudentIds.delete(id);
            updateBulkUI();
        }

        function toggleSelectAll(checked) {
            const visible = _lastVisibleStudentIds || [];
            if (checked) visible.forEach(id => selectedStudentIds.add(id));
            else visible.forEach(id => selectedStudentIds.delete(id));
            updateBulkUI();
            renderTable();
        }

        function clearSelection() {
            selectedStudentIds.clear();
            updateBulkUI();
            const allEl = document.getElementById('select-all-students');
            if (allEl) { allEl.checked = false; allEl.indeterminate = false; }
        }

        function openBulkHwMenu(e, el) {
            if (e) e.stopPropagation();
            syncActiveInputs({ save: true });
            if (selectedStudentIds.size === 0) return showToast("먼저 학생을 선택하세요.");

            activeHwStudentId = '__bulk__';
            const m = document.getElementById('hw-selector-menu');
            const r = el.getBoundingClientRect();
            m.style.display = 'flex';
            m.style.top = (r.bottom + window.scrollY + 5) + 'px';
            m.style.left = (r.left + window.scrollX) + 'px';
        }

        // ✅ 새로 추가: 데이터 메뉴 / 주차 메뉴
        function openDataMenu(el) {
            const m = document.getElementById('data-menu');
            const r = el.getBoundingClientRect();
            m.style.display = 'flex';
            m.style.top = (r.bottom + window.scrollY + 6) + 'px';
            m.style.left = (r.left + window.scrollX) + 'px';
        }

        function openWeekMenu(el) {
            const m = document.getElementById('week-menu');
            const r = el.getBoundingClientRect();
            m.style.display = 'flex';
            m.style.top = (r.bottom + window.scrollY + 6) + 'px';
            m.style.left = (r.left + window.scrollX) + 'px';
        }

        // =============================
        // 비즈니스 로직 및 렌더링
        // =============================
        function renderClassSelection() {
            const list = document.getElementById('class-list');
            list.innerHTML = db.classes.map(c => `
        <div class="bg-white p-10 rounded-[3rem] border border-slate-100 hover:border-indigo-500 hover:shadow-2xl transition-all group relative">
          <div class="absolute top-6 right-6 flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
            <button onclick="editClass('${c.id}', event)" class="p-3 bg-slate-100 hover:bg-indigo-100 rounded-2xl"><i data-lucide="edit-2" size="16"></i></button>
            <button onclick="triggerDeleteClass('${c.id}', event)" class="p-3 bg-slate-100 hover:bg-rose-100 rounded-2xl"><i data-lucide="trash-2" size="16"></i></button>
          </div>
          <div onclick="enterClass('${c.id}')" class="cursor-pointer">
            <div class="bg-indigo-600 w-16 h-16 rounded-[1.5rem] flex items-center justify-center text-white mb-8 shadow-lg"><i data-lucide="book-open"></i></div>
            <h3 class="text-3xl font-black text-slate-800 mb-2">${c.name}</h3>
            <p class="text-slate-400 font-bold text-xs uppercase mb-8">${c.schedule}</p>
            <div class="text-indigo-600 font-black text-sm">입장하기 →</div>
          </div>
        </div>`).join('');
            lucide.createIcons();
        }

        function enterClass(id) {
            currentClassId = id;
            clearSelection();

            const cls = db.classes.find(c => c.id === id);
            document.getElementById('active-class-name').innerText = cls.name;
            document.getElementById('active-class-schedule').innerText = cls.schedule;
            document.getElementById('class-selection').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');

            const cls2 = db.classes.find(c => c.id === id);

            if (!Number.isFinite(cls2.weekCount) || cls2.weekCount < 1) {
                cls2.weekCount = inferWeekCountForClass(id);
                saveDBImmediate();
            }

            totalWeeks = cls2.weekCount;
            currentWeek = cls2.weekCount;

            renderWeekSelector();
            updateFilterBadge();
            switchTab('students');
        }

        function renderTable() {
            const tbody = document.getElementById('student-table-body');

            // ✅ 여기서만 “검색+필터” 반영
            let filtered = getFilteredStudents({ includeSearch: true });

            filtered.sort((a, b) => {
                const dA = getWeekDataSafe(a, currentWeek);
                const dB = getWeekDataSafe(b, currentWeek);

                let vA, vB;
                if (sortKey === 'name') { vA = a.name; vB = b.name; }
                else if (sortKey === 'homework') { vA = dA.homework; vB = dB.homework; }
                else { vA = dA[sortKey] || 0; vB = dB[sortKey] || 0; }
                return vA < vB ? (sortDir === 'asc' ? -1 : 1) : (vA > vB ? (sortDir === 'asc' ? 1 : -1) : 0);
            });

            _lastVisibleStudentIds = filtered.map(s => s.id);

            tbody.innerHTML = filtered.map(s => {
                const d = getWeekDataSafe(s, currentWeek);
                const checked = selectedStudentIds.has(s.id) ? 'checked' : '';
                return `
          <tr class="hover:bg-slate-50 transition-all">
            <td class="px-4 py-4 text-center">
              <input type="checkbox" ${checked} onchange="toggleSelectStudent('${s.id}', this.checked)"
                class="w-4 h-4 accent-indigo-600 cursor-pointer">
            </td>

            <td class="px-6 py-4">
              <input type="text" data-sync="student" data-id="${s.id}" data-field="name" value="${escapeHtml(s.name)}"
                oninput="updateStudent('${s.id}', 'name', this.value)" ondblclick="openStudentCard('${s.id}')"
                class="w-full bg-transparent font-black text-indigo-600 outline-none cursor-help">
            </td>
            <td class="px-6 py-4">
              <input type="text" data-sync="student" data-id="${s.id}" data-field="studentPhone" value="${escapeHtml(s.studentPhone || '')}"
                oninput="updateStudent('${s.id}', 'studentPhone', this.value)"
                class="w-full bg-transparent font-bold text-slate-700 outline-none">
            </td>
            <td class="px-6 py-4">
              <input type="text" data-sync="student" data-id="${s.id}" data-field="parentPhone" value="${escapeHtml(s.parentPhone || '')}"
                oninput="updateStudent('${s.id}', 'parentPhone', this.value)"
                class="w-full bg-transparent font-bold text-slate-500 outline-none">
            </td>
            <td class="px-6 py-4 text-center">
              <div onclick="openHwMenu(this, '${s.id}')" class="state-tag inline-block px-5 py-2 rounded-xl text-[10px] font-black cursor-pointer ${homeworkColors[d.homework] || homeworkColors['미제출']}">${escapeHtml(d.homework)}</div>
            </td>
            <td class="px-6 py-4">
              <input type="number" data-sync="week" data-id="${s.id}" data-field="exam1" value="${Number(d.exam1 || 0)}"
                oninput="updateData('${s.id}', 'exam1', this.value)" class="w-full text-center bg-transparent font-black outline-none">
            </td>
            <td class="px-6 py-4">
              <input type="number" data-sync="week" data-id="${s.id}" data-field="exam2" value="${Number(d.exam2 || 0)}"
                oninput="updateData('${s.id}', 'exam2', this.value)" class="w-full text-center bg-transparent font-black outline-none">
            </td>
            <td class="px-6 py-4">
              <input type="text" data-sync="week" data-id="${s.id}" data-field="incorrect" value="${escapeHtml(d.incorrect || '')}"
                oninput="updateData('${s.id}', 'incorrect', this.value)" placeholder="문항"
                class="w-full bg-transparent text-[11px] font-bold text-slate-300 italic outline-none">
            </td>
          </tr>`;
            }).join('');

            updateBulkUI();
            lucide.createIcons();
        }

        function renderGradingTable() {
            const tbody = document.getElementById('grading-body');
            tbody.innerHTML = gradingData.map(row => {
                let ins = '';
                for (let i = 0; i < 20; i++) ins += `<td class="p-1 border-r border-slate-200"><input type="text" value="${row.answers[i]}" oninput="gradingData.find(d=>d.id==='${row.id}').answers[${i}]=this.value" class="w-8 h-8 text-center text-xs font-bold bg-white border border-slate-100 rounded outline-none focus:bg-indigo-50"></td>`;
                return `<tr class="hover:bg-slate-50">
          <td class="px-2 text-center"><button onclick="gradingData=gradingData.filter(d=>d.id!=='${row.id}');renderGradingTable();" class="text-slate-300 hover:text-rose-500"><i data-lucide="x-circle" size="14"></i></button></td>
          <td class="px-4 font-bold sticky left-10 bg-white border-r z-10">${escapeHtml(row.name)}</td>
          ${ins}
          <td class="px-4 text-center font-black text-indigo-600 bg-indigo-50/50">${row.score}</td>
          <td class="px-4 text-center font-black text-rose-500 bg-rose-50/50">${row.wrongs}</td>
        </tr>`;
            }).join('');
            updateStats(); lucide.createIcons();
        }

        function renderLineChart(myData, classData) {
            const svg = document.getElementById('trend-svg');
            const w = svg.parentElement.clientWidth - 64, h = svg.parentElement.clientHeight - 64;
            svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
            svg.innerHTML = '';
            const getX = (i) => 20 + (i * (w - 40) / (Math.max(1, myData.length - 1)));
            const getY = (v) => h - 20 - (v * (h - 40) / 50);
            const draw = (data, color, dash = false) => {
                if (!data.length) return;
                let d = `M ${getX(0)} ${getY(data[0])}`;
                for (let i = 1; i < data.length; i++) d += ` L ${getX(i)} ${getY(data[i])}`;
                const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                p.setAttribute("d", d); p.setAttribute("stroke", color); p.setAttribute("fill", "none"); p.setAttribute("stroke-width", "4");
                if (dash) p.setAttribute("stroke-dasharray", "6,6");
                p.classList.add("line-path"); svg.appendChild(p);
            };
            if (classData.length) draw(classData, "#e2e8f0", true);
            if (myData.length) draw(myData, "#4f46e5");
        }

        function openStudentCard(id) {
            syncActiveInputs();
            currentModalStudentId = id;
            const s = db.students.find(x => x.id === id);
            document.getElementById('modal-student-name').innerText = s.name;
            document.getElementById('modal-notes').value = s.notes || '';
            document.getElementById('modal-mock-june').innerText = s.mock.june + "점";
            document.getElementById('modal-mock-sept').innerText = s.mock.sept + "점";

            const wb = document.getElementById('withdraw-trigger-btn');
            if (s.withdrawn) {
                wb.innerHTML = `<i data-lucide="rotate-ccw" size="16"></i> 복원하기`;
                wb.onclick = () => restoreStudent(id);
            } else {
                wb.innerHTML = `<i data-lucide="user-minus" size="16"></i> 퇴원 처리`;
                wb.onclick = () => {
                    openConfirm("퇴원 처리", `${s.name} 학생을 퇴원생 목록으로 옮길까요?`, () => {
                        s.withdrawn = true; s.withdrawnAt = Date.now(); saveDB(); closeModal(); renderTable();
                    });
                };
            }

            let myTrend = [], classTrend = [];
            for (let w = 1; w <= totalWeeks; w++) {
                const d = getWeekDataSafe(s, w);
                myTrend.push((d.exam1 + d.exam2) / 2);
                const all = db.students.filter(x => x.classId === currentClassId && !x.withdrawn).map(x => x.weeks[w]).filter(Boolean);
                const avg = all.length ? all.reduce((a, b) => a + (b.exam1 + b.exam2) / 2, 0) / all.length : 0;
                classTrend.push(avg);
            }
            document.getElementById('student-modal').classList.remove('hidden');
            setTimeout(() => renderLineChart(myTrend, classTrend), 100);
            lucide.createIcons();
        }

        function renderWithdrawnTable() {
            const tbody = document.getElementById('withdrawn-table-body');
            const list = db.students.filter(s => s.classId === currentClassId && s.withdrawn);
            tbody.innerHTML = list.map(s => `
        <tr class="hover:bg-slate-50 transition-all">
          <td class="px-6 py-4 font-black cursor-help hover:text-indigo-600" ondblclick="openStudentCard('${s.id}')">${escapeHtml(s.name)}</td>
          <td class="px-6 py-4">${escapeHtml(s.studentPhone || '')}</td>
          <td class="px-6 py-4">${escapeHtml(s.parentPhone || '')}</td>
          <td class="px-6 py-4 text-slate-400 font-bold">${new Date(s.withdrawnAt).toLocaleDateString()}</td>
          <td class="px-6 py-4 text-right">
            <button onclick="restoreStudent('${s.id}')" class="text-emerald-600 font-bold mr-4">복원</button>
            <button onclick="deleteStudentForever('${s.id}')" class="text-rose-600 font-bold">삭제</button>
          </td>
        </tr>`).join('');
            lucide.createIcons();
        }

        function renderMockTable() {
            const tbody = document.getElementById('mock-table-body');
            const filtered = db.students.filter(s => s.classId === currentClassId && !s.withdrawn);
            tbody.innerHTML = filtered.map(s => `
        <tr class="hover:bg-slate-50">
          <td class="px-6 py-4 font-black">${escapeHtml(s.name)}</td>
          <td class="px-6 py-4"><input type="number" value="${Number(s.mock.june || 0)}" onchange="updateMock('${s.id}', 'june', this.value)" class="w-full text-center py-3 bg-slate-50 rounded-xl font-black outline-none"></td>
          <td class="px-6 py-4"><input type="number" value="${Number(s.mock.sept || 0)}" onchange="updateMock('${s.id}', 'sept', this.value)" class="w-full text-center py-3 bg-slate-50 rounded-xl font-black outline-none"></td>
        </tr>`).join('');
        }

        function getActiveClassObj() {
            return db.classes.find(c => c.id === currentClassId);
        }

        function isMeaningfulWeekData(d) {
            if (!d) return false;
            const hwMeaning = d.homework && d.homework !== '미제출';
            const e1 = Number(d.exam1 || 0);
            const e2 = Number(d.exam2 || 0);
            const inc = (d.incorrect || "").trim();
            return hwMeaning || e1 !== 0 || e2 !== 0 || inc !== "";
        }

        function inferWeekCountForClass(classId) {
            const students = db.students.filter(s => s.classId === classId);
            let maxW = 1;
            students.forEach(s => {
                const weeksObj = s.weeks && typeof s.weeks === 'object' ? s.weeks : {};
                Object.entries(weeksObj).forEach(([wk, data]) => {
                    const n = Number(wk);
                    if (!Number.isFinite(n)) return;
                    if (isMeaningfulWeekData(data)) maxW = Math.max(maxW, n);
                });
            });
            return Math.max(1, maxW);
        }

        function switchTab(t) {
            syncActiveInputs();
            ['students', 'mock', 'grading', 'withdrawn'].forEach(id => {
                document.getElementById('content-' + id).classList.toggle('hidden', id !== t);
                document.getElementById('tab-btn-' + id).className = (id === t)
                    ? "px-6 py-2.5 rounded-xl text-xs font-black bg-white text-indigo-600 shadow-sm"
                    : "px-6 py-2.5 rounded-xl text-xs font-black text-slate-400";
            });
            if (t === 'students') { updateFilterBadge(); renderTable(); }
            if (t === 'mock') renderMockTable();
            if (t === 'grading') renderGradingTable();
            if (t === 'withdrawn') renderWithdrawnTable();
            lucide.createIcons();
        }

        function updateStudent(id, f, v) {
            const s = db.students.find(x => x.id === id);
            if (s) { s[f] = v; if (f === 'parentPhone') s.phone = v; saveDB(); }
        }
        function updateData(id, f, v) {
            const s = db.students.find(x => x.id === id);
            if (!s.weeks[currentWeek]) s.weeks[currentWeek] = { homework: '미제출', exam1: 0, exam2: 0, incorrect: '' };
            s.weeks[currentWeek][f] = (f === 'exam1' || f === 'exam2') ? Number(v) : v; saveDB();
        }
        function updateMock(id, f, v) { const s = db.students.find(x => x.id === id); s.mock[f] = Number(v); saveDB(); }
        function saveNotes() { db.students.find(x => x.id === currentModalStudentId).notes = document.getElementById('modal-notes').value; saveDB(); }
        function restoreStudent(id) { const s = db.students.find(x => x.id === id); s.withdrawn = false; s.withdrawnAt = 0; saveDB(); renderWithdrawnTable(); renderTable(); closeModal(); showToast("복원되었습니다."); }
        function deleteStudentForever(id) { openConfirm("영구 삭제", "데이터를 되돌릴 수 없습니다.", () => { db.students = db.students.filter(x => x.id !== id); saveDB(); renderWithdrawnTable(); }); }
        function loadStudentsToGrading() { gradingData = db.students.filter(s => s.classId === currentClassId && !s.withdrawn).map(s => ({ id: s.id, name: s.name, answers: Array(20).fill(""), score: 0, wrongs: 0 })); renderGradingTable(); showToast("학생 명단 동기화 완료"); }
        function runGrading() {
            const key = Array.from({ length: 20 }, (_, i) => document.getElementById(`ans-${i + 1}`).value || "");
            const pts = Array.from({ length: 20 }, (_, i) => parseInt(document.getElementById(`pt-${i + 1}`).value));
            gradingData.forEach(row => {
                let score = 0, wrongs = 0;
                row.answers.forEach((ans, i) => { if (ans && ans === key[i]) score += pts[i]; else if (key[i]) wrongs++; });
                row.score = score; row.wrongs = wrongs;
            });
            renderGradingTable(); showToast("채점 완료");
        }
        function updateStats() {
            const scs = gradingData.map(r => r.score);
            const count = scs.length;
            if (!count) return;
            document.getElementById('stat-count').innerText = count + "명";
            document.getElementById('stat-max').innerText = Math.max(...scs);
            document.getElementById('stat-min').innerText = Math.min(...scs);
            document.getElementById('stat-avg').innerText = (scs.reduce((a, b) => a + b, 0) / count).toFixed(1);
        }
        function openConfirm(t, m, c) { document.getElementById('confirm-title').innerText = t; document.getElementById('confirm-message').innerText = m; document.getElementById('confirm-modal').classList.remove('hidden'); document.getElementById('confirm-action-btn').onclick = () => { c(); closeConfirm(); }; }
        function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden'); }
        function closeModal() { document.getElementById('student-modal').classList.add('hidden'); }
        function closeClassModal() { document.getElementById('class-modal').classList.add('hidden'); }
        function openClassModal(id = null) {
            editingClassId = id;
            document.getElementById('class-modal').classList.remove('hidden');
            if (id) {
                const c = db.classes.find(x => x.id === id);
                document.getElementById('modal-input-name').value = c.name;
                document.getElementById('modal-input-schedule').value = c.schedule;
            } else {
                document.getElementById('modal-input-name').value = "";
                document.getElementById('modal-input-schedule').value = "";
            }
        }
        function exitToClassSelection() { document.getElementById('main-dashboard').classList.add('hidden'); document.getElementById('class-selection').classList.remove('hidden'); renderClassSelection(); }
        function saveClass() {
            const n = document.getElementById('modal-input-name').value,
                s = document.getElementById('modal-input-schedule').value;
            if (!n) return;

            if (editingClassId) {
                const c = db.classes.find(x => x.id === editingClassId);
                c.name = n;
                c.schedule = s;
            } else {
                db.classes.push({ id: 'c-' + getUUID(), name: n, schedule: s, weekCount: 1 });
            }
            saveDB();
            closeClassModal();
            renderClassSelection();
        }
        function triggerDeleteClass(id, e) {
            e.stopPropagation();
            openConfirm("수업 삭제", "해당 수업의 모든 학생 데이터가 삭제됩니다.", () => {
                db.classes = db.classes.filter(x => x.id !== id);
                db.students = db.students.filter(x => x.classId !== id);
                saveDB();
                renderClassSelection();
            });
        }

        function openHwMenu(el, id) {
            activeHwStudentId = id;
            const m = document.getElementById('hw-selector-menu');
            const r = el.getBoundingClientRect();
            m.style.display = 'flex';
            m.style.top = (r.bottom + window.scrollY + 5) + 'px';
            m.style.left = (r.left + window.scrollX) + 'px';
        }

        function setHomeworkStatus(s) {
            if (activeHwStudentId === '__bulk__') {
                if (selectedStudentIds.size === 0) { document.getElementById('hw-selector-menu').style.display = 'none'; return showToast("선택된 학생이 없습니다."); }

                let applied = 0;
                db.students
                    .filter(x => x.classId === currentClassId && !x.withdrawn && selectedStudentIds.has(x.id))
                    .forEach(st => {
                        if (!st.weeks[currentWeek]) st.weeks[currentWeek] = { homework: '미제출', exam1: 0, exam2: 0, incorrect: '' };
                        st.weeks[currentWeek].homework = s;
                        applied++;
                    });

                document.getElementById('hw-selector-menu').style.display = 'none';
                saveDB();
                renderTable();
                showToast(`과제/출석 일괄 변경 완료 (${applied}명)`);
                return;
            }

            const st = db.students.find(x => x.id === activeHwStudentId);
            if (!st.weeks[currentWeek]) st.weeks[currentWeek] = { homework: '미제출', exam1: 0, exam2: 0, incorrect: '' };
            st.weeks[currentWeek].homework = s;
            document.getElementById('hw-selector-menu').style.display = 'none';
            saveDB();
            renderTable();
        }

        function openPpurioMenu(el) {
            const m = document.getElementById('ppurio-menu');
            const r = el.getBoundingClientRect();
            m.style.display = 'flex';
            m.style.top = (r.bottom + window.scrollY + 5) + 'px';
            m.style.left = (r.left + window.scrollX) + 'px';
        }

        function handleSort(k) { syncActiveInputs(); if (sortKey === k) sortDir = (sortDir === 'asc' ? 'desc' : 'asc'); else { sortKey = k; sortDir = 'asc'; } renderTable(); }
        function handleMockSort(k) { syncActiveInputs(); if (mockSortKey === k) mockSortDir = (mockSortDir === 'asc' ? 'desc' : 'asc'); else { mockSortKey = k; mockSortDir = 'asc'; } renderMockTable(); }
        function handleGradingSort() { gradingSortDir = (gradingSortDir === 'asc' ? 'desc' : 'asc'); renderGradingTable(); }
        function renderWeekSelector() { const s = document.getElementById('week-selector'); s.innerHTML = Array.from({ length: totalWeeks }, (_, i) => `<option value="${i + 1}" ${i + 1 === currentWeek ? 'selected' : ''}>주차 ${i + 1}</option>`).join(''); }
        function jumpToWeek(v) { syncActiveInputs(); currentWeek = parseInt(v); renderTable(); clearSelection(); updateFilterBadge(); }
        function changeWeek(d) { syncActiveInputs(); const next = Math.max(1, Math.min(totalWeeks, currentWeek + d)); currentWeek = next; renderWeekSelector(); renderTable(); clearSelection(); updateFilterBadge(); }

        function addNewWeek() {
            syncActiveInputs();
            const cls = getActiveClassObj();
            if (!cls) return;

            cls.weekCount = (Number(cls.weekCount) || 1) + 1;
            totalWeeks = cls.weekCount;
            currentWeek = totalWeeks;

            saveDB();
            renderWeekSelector();
            renderTable();
            clearSelection();
            updateFilterBadge();
            showToast(totalWeeks + "주차 생성");
        }

        function openTransferModal() { syncActiveInputs(); if (!gradingData.length) return showToast("채점 데이터가 없습니다."); document.getElementById('transfer-week-select').innerHTML = Array.from({ length: totalWeeks }, (_, i) => `<option value="${i + 1}">주차 ${i + 1}</option>`).join(''); document.getElementById('transfer-modal').classList.remove('hidden'); }
        function closeTransferModal() { document.getElementById('transfer-modal').classList.add('hidden'); }
        function setTransferTarget(t) { transferTarget = t; document.getElementById('btn-target-exam1').className = t === 'exam1' ? "flex-1 py-3 bg-emerald-600 text-white rounded-xl font-black text-sm" : "flex-1 py-3 bg-slate-100 text-slate-400 rounded-xl font-black text-sm"; document.getElementById('btn-target-exam2').className = t === 'exam2' ? "flex-1 py-3 bg-emerald-600 text-white rounded-xl font-black text-sm" : "flex-1 py-3 bg-slate-100 text-slate-400 rounded-xl font-black text-sm"; }
        function executeTransfer() { const w = document.getElementById('transfer-week-select').value; gradingData.forEach(d => { const s = db.students.find(x => x.id === d.id); if (!s.weeks[w]) s.weeks[w] = { homework: '미제출', exam1: 0, exam2: 0, incorrect: '' }; s.weeks[w][transferTarget] = d.score; }); saveDB(); closeTransferModal(); renderTable(); showToast("시험 점수 전송 완료"); }

        function exportBackupJSON() { syncActiveInputs(); const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `SmartAcademy_Backup_${new Date().toISOString().slice(0, 10)}.json`; a.click(); }
        function triggerImportBackupJSON() { const i = document.getElementById('backup-file-input'); i.onchange = e => { const f = e.target.files[0]; const r = new FileReader(); r.onload = ev => { db = JSON.parse(ev.target.result); normalizeDB(); saveDBImmediate(); renderClassSelection(); showToast("백업 불러오기 완료"); }; r.readAsText(f); }; i.click(); }
        function triggerResetData() { openConfirm("초기화", "모든 데이터가 삭제됩니다. 계속하시겠습니까?", () => { localStorage.clear(); location.reload(); }); }
        function editClass(id, e) { e.stopPropagation(); openClassModal(id); }

        function addNewStudent() {
            syncActiveInputs();
            db.students.push({ id: getUUID(), classId: currentClassId, name: '새 학생', studentPhone: '', parentPhone: '', phone: '', withdrawn: false, withdrawnAt: 0, weeks: {}, mock: { june: 0, sept: 0 }, notes: '' });
            saveDB();
            renderTable();
        }

        window.onload = () => {
            loadDB();
            renderClassSelection();
            lucide.createIcons();

            document.addEventListener('click', (e) => {
                const hwMenu = document.getElementById('hw-selector-menu');
                const ppMenu = document.getElementById('ppurio-menu');
                const dataMenu = document.getElementById('data-menu');
                const weekMenu = document.getElementById('week-menu');

                // ✅ 과제/출석 메뉴 닫기 조건
                if (
                    hwMenu &&
                    !e.target.closest('#hw-selector-menu') &&
                    !e.target.closest('.state-tag') &&
                    !e.target.closest('#bulk-hw-btn')
                ) {
                    hwMenu.style.display = 'none';
                }

                // ✅ 발송 메뉴 닫기
                if (ppMenu && !e.target.closest('#ppurio-menu') && !e.target.closest('[onclick*="openPpurioMenu"]')) {
                    ppMenu.style.display = 'none';
                }

                // ✅ 데이터 메뉴 닫기
                if (dataMenu && !e.target.closest('#data-menu') && !e.target.closest('[onclick*="openDataMenu"]')) {
                    dataMenu.style.display = 'none';
                }

                // ✅ 주차 메뉴 닫기
                if (weekMenu && !e.target.closest('#week-menu') && !e.target.closest('[onclick*="openWeekMenu"]')) {
                    weekMenu.style.display = 'none';
                }
            });

            // ✅ 필터 모달: ESC로 닫기
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const fm = document.getElementById('filter-modal');
                    if (fm && !fm.classList.contains('hidden')) closeFilterModal();
                }
            });

            document.addEventListener('keydown', e => {
                if ((e.ctrlKey || e.metaKey) && e.key === ';') {
                    e.preventDefault();
                    const v = document.getElementById('content-withdrawn').classList.contains('hidden');
                    switchTab(v ? 'withdrawn' : 'students');
                }
            });

            updateFilterBadge();
        };

        function openImportModal() {
            syncActiveInputs({ save: true });
            const hint = document.getElementById('import-week-hint');
            if (hint) hint.innerText = `현재 ${currentWeek}주차 데이터로 입력됩니다.`;
            document.getElementById('import-area').value = '';
            document.getElementById('import-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('import-area')?.focus(), 50);
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
        }

        function processImport() {
            syncActiveInputs({ save: true });

            const area = document.getElementById('import-area');
            const raw = (area?.value || '').trim();
            if (!raw) return showToast("붙여넣은 데이터가 없습니다.");

            const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            let updated = 0, created = 0;

            for (const line of lines) {
                const cols = line.split('\t');
                if (cols.length < 3) continue;

                const name = (cols[0] || '').trim();
                const studentPhone = (cols[1] || '').trim();
                const parentPhone = (cols[2] || '').trim();
                const homework = (cols[3] || '미제출').trim() || '미제출';
                const exam1 = Number((cols[4] || '0').trim()) || 0;
                const exam2 = Number((cols[5] || '0').trim()) || 0;
                const incorrect = (cols[6] || '').trim();

                if (!name) continue;

                let s = db.students.find(x =>
                    x.classId === currentClassId &&
                    (x.name || '').trim() === name &&
                    (x.parentPhone || '').trim() === parentPhone
                );

                if (!s) {
                    s = {
                        id: getUUID(),
                        classId: currentClassId,
                        name,
                        studentPhone,
                        parentPhone,
                        phone: parentPhone,
                        withdrawn: false,
                        withdrawnAt: 0,
                        weeks: {},
                        mock: { june: 0, sept: 0 },
                        notes: ''
                    };
                    db.students.push(s);
                    created++;
                } else {
                    s.studentPhone = studentPhone;
                    s.parentPhone = parentPhone;
                    s.phone = parentPhone;
                    s.withdrawn = false;
                    updated++;
                }

                if (!s.weeks) s.weeks = {};
                if (!s.weeks[currentWeek]) s.weeks[currentWeek] = { homework: '미제출', exam1: 0, exam2: 0, incorrect: '' };

                s.weeks[currentWeek].homework = homework;
                s.weeks[currentWeek].exam1 = exam1;
                s.weeks[currentWeek].exam2 = exam2;
                s.weeks[currentWeek].incorrect = incorrect;
            }

            normalizeDB();
            saveDBImmediate();
            closeImportModal();
            renderTable();
            showToast(`가져오기 완료 (신규 ${created} / 업데이트 ${updated})`);
        }
    </script>
</body>

</html>